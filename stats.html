<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì „ì²´ í†µê³„ (ì›”Â·ì‹œë‚˜ë¦¬ì˜¤ í•„í„°)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 text-lg sm:text-xl">
  <div class="max-w-5xl mx-auto p-8">
    <h1 class="text-4xl font-extrabold text-center mb-8">ğŸ“Š ì „ì²´ í†µê³„</h1>

    <!-- ì›”(ë‹¬) ì„ íƒ -->
    <div class="flex justify-center items-center gap-4 mb-6">
      <label class="text-2xl font-semibold">ì›” ì„ íƒ:</label>
      <select id="monthFilter" class="border p-3 rounded text-2xl">
        <option value="all">ì „ì²´</option>
        <!-- ì‹¤ì œ ì˜µì…˜ì€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </select>
    </div>

    <!-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ -->
    <div class="flex justify-center items-center gap-4 mb-6">
      <label class="text-2xl font-semibold">ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ:</label>
      <select id="scenarioFilter" class="border p-3 rounded text-2xl">
        <option value="all">ì „ì²´</option>
        <option value="íŠ¸ëŸ¬ë¸” ë¸Œë£¨ì‰">íŠ¸ëŸ¬ë¸” ë¸Œë£¨ì‰</option>
        <option value="ì„¹ì¸ ì•¤ë°”ì´ì˜¬ë ›">ì„¹ì¸ ì•¤ë°”ì´ì˜¬ë ›</option>
        <option value="ë°°ë“œë¬¸ë¼ì´ì§•">ë°°ë“œë¬¸ë¼ì´ì§•</option>
        <option value="í¬ì¼“ëª¬ìŠ¤í„°">í¬ì¼“ëª¬ìŠ¤í„°</option>
        <option value="ë°˜ë€ì˜ ê±°ì¹œë°”ë‹¤">ë°˜ë€ì˜ ê±°ì¹œë°”ë‹¤</option>
        <option value="ë¡œë§ˆ">ë¡œë§ˆ</option>
      </select>
    </div>

    <div id="summary" class="space-y-6 text-center text-2xl"></div>

    <div class="mt-10 text-center">
      <a href="index.html" class="text-blue-500 hover:underline text-2xl">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>

<script>
// Firebase ì´ˆê¸°í™”
const firebaseConfig = {
  apiKey: "AIzaSyCqk52hH5uwWvC8L81l8d6kZgCN2Ynt_Rg",
  authDomain: "blood-on-the-clock-tower-613ce.firebaseapp.com",
  projectId: "blood-on-the-clock-tower-613ce",
  storageBucket: "blood-on-the-clock-tower-613ce.firebasestorage.app",
  messagingSenderId: "619177302977",
  appId: "1:619177302977:web:3b282744ff5b00469e6d40"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ìºë¦­í„° ê·¸ë£¹
const demons = ["ì„í”„", "íŒ¡êµ¬", "ë¹„ê³ ëª¨ë¥´í‹°ìŠ¤", "ë…¸ë‹¤ì‹œ", "ë³¼í…ìŠ¤", "ì¢€ë¶€ìš¸", "í‘¸ì¹´", "ìƒ¤ë°œë¡¯", "í¬", "ë…ì¹¨ë¶•", "íŒ¬í…€", "ë®¤ì¸ ", "ë¡œì¼“ë‹¨", "í¬ë¼ì¼„", "ì¹¼ë¦½ì†Œ", "ë£¨ì‚´ì¹´", "ìš°ë¯¸ë³´ì¦ˆ", "í´ë ˆì˜¤íŒŒíŠ¸ë¼", "í•œë‹ˆë°œ", "í¬ë¼ìˆ˜ìŠ¤", "ì¹´ì´ì‚¬ë¥´"];
const minions = ["ë…ì‚´ë²”", "ìŠ¤íŒŒì´", "ë¶€ì •í•œì—¬ì", "ë‚¨ì‘", "ì‚¬ì•…í•œìŒë‘¥ì´", "ë§ˆë…€", "ì„¸ë ˆë…¸ë¶€ìŠ¤", "í”¼íŠ¸í•µ", "ëŒ€ë¶€", "ì•…ë§ˆì˜ëŒ€ë³€ì¸", "ì•”ì‚´ì", "ë°°í›„ì¸ë¬¼", "ë§ˆììš©", "ì§ˆë»ê¸°", "ë‚˜ì˜¹", "ë¶ë³¼", "ì‹ ë¹„ì—¬ì‚¬ì œ", "ë°”ë‹¤ì •ë ¹", "ì–¸ë°ë“œí•´ì ", "ì‚´ì í¬ì‹ì", "ìš”ë¶€", "ê¸€ë¦¬ì½˜", "ë‚´ì¥ì ìˆ ê°€", "ì¡°ì ê´€"];
const outsiders = ["ì§‘ì‚¬", "ì£¼ì •ë±…ì´", "ì€ë‘”ì", "ì„±ì", "ëŒì—°ë³€ì´", "ì—°ì¸", "ì´ë°œì‚¬", "ëª¨ì§€ë¦¬", "ë•œì¥ì´", "ë¬¸ì°¨ì¼ë“œ", "ê¹¡íŒ¨", "ë¯¸ì¹˜ê´‘ì´", "ë”±ì¶©ì´", "ê³ ì˜¤ì“°", "ì‰ì–´í‚¹&ê°¸ë¼ë„ìŠ¤", "ë®¤", "ë”°ê°œë¹„", "ì¸ì–´", "ì½”ì£¼ë¶€", "ë°€í•­ì", "ìŒë‘¥ì´", "ìŠ¤íŒŒë¥´íƒ€ì¿ ìŠ¤", "ì™€ì¸ì œì¡°ì", "ë¶ˆê¸¸í•œì§•ì¡°"];

// ìœ í‹¸: ì•„ì´ì½˜
function getIcon(char){
  if (demons.includes(char))   return "ğŸ˜ˆ";
  if (minions.includes(char))  return "ğŸ§Ÿ";
  if (outsiders.includes(char))return "ğŸ¤¡";
  return "ğŸ§‘â€ğŸŒ¾";
}
// ìœ í‹¸: ì •ë ¬
function sortEntries(charWins){
  return Object.entries(charWins).sort((a,b)=>{
    const ar = a[1].win / a[1].total;
    const br = b[1].win / b[1].total;
    if (br !== ar) return br - ar;                      // ìŠ¹ë¥ 
    if (b[1].win !== a[1].win) return b[1].win - a[1].win; // ìŠ¹ìˆ˜
    if (b[1].total !== a[1].total) return b[1].total - a[1].total; // ì „ì 
    return a[0].localeCompare(b[0]);                    // ì´ë¦„
  });
}
// ìœ í‹¸: ë…„-ì›” ë¬¸ìì—´
function getMonthStr(dateObj){
  const m = (dateObj.getMonth() + 1).toString().padStart(2,"0");
  return `${dateObj.getFullYear()}-${m}`;
}
// DOM í—¬í¼
function createP(html){const p=document.createElement("p");p.innerHTML=html;return p;}
function hr(){const h=document.createElement("hr");h.className="my-6";return h;}

// ì „ì—­ ê²Œì„ ë°ì´í„°
let allGames = [];

// ì›” ì˜µì…˜ ì±„ìš°ê¸°
async function populateMonths(){
  const snap = await db.collection("games").get();
  allGames = snap.docs.map(d=>d.data());

  const monthSet = new Set();
  allGames.forEach(g=>{
    const rawDate = g.date || g.playedAt || g.timestamp; // í•„ë“œëª…ì€ ìƒí™©ì— ë§ê²Œ ì¡°ì •
    const jsDate = rawDate && rawDate.seconds ? new Date(rawDate.seconds*1000) : new Date(rawDate);
    monthSet.add(getMonthStr(jsDate));
  });

  const monthFilter = document.getElementById("monthFilter");
  // ê¸°ì¡´ ì˜µì…˜(ì „ì²´) ì™¸ ëª¨ë‘ ì œê±°
  while(monthFilter.options.length > 1) monthFilter.remove(1);

  Array.from(monthSet).sort().reverse().forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    monthFilter.appendChild(opt);
  });
}

// í™”ë©´ ê·¸ë¦¬ê¸°
function build(){
  const scenario = document.getElementById("scenarioFilter").value;
  const month    = document.getElementById("monthFilter").value;

  // í•„í„°ë§
  const games = allGames.filter(g=>{
    // ì‹œë‚˜ë¦¬ì˜¤ í•„í„°
    if (scenario !== "all" && g.scenario !== scenario) return false;
    // ì›” í•„í„°
    if (month !== "all"){
      const rawDate = g.date || g.playedAt || g.timestamp;
      const jsDate = rawDate && rawDate.seconds ? new Date(rawDate.seconds*1000) : new Date(rawDate);
      if (getMonthStr(jsDate) !== month) return false;
    }
    return true;
  });

  // ìŠ¹ë¦¬ ì§‘ê³„
  let charWins = {};
  let teamWin = { "ì„ ": 0, "ì•…": 0 };

  games.forEach(g=>{
    /* íŒ€ ìŠ¹ë¦¬ ì¹´ìš´íŠ¸ */
    if (g.winningTeam === "ì„ íŒ€") teamWin["ì„ "]++;
    else if (g.winningTeam === "ì•…íŒ€") teamWin["ì•…"]++;
g.players.forEach(p=>{
      const c = p.character;
      const win = p.win === "ìŠ¹ë¦¬";
      if(!charWins[c]) charWins[c] = {win:0,total:0};
      charWins[c].total++;
      if(win) charWins[c].win++;

      
    });
    });

  // ìš”ì•½ ì¶œë ¥
  const summary = document.getElementById("summary");
  summary.innerHTML = "";
  summary.appendChild(createP(`ì „ì²´ ê²Œì„ ìˆ˜: <strong>${games.length}</strong>`));
  summary.appendChild(createP(`ğŸ§‘â€ğŸŒ¾ <strong>ì„ íŒ€ ìŠ¹ë¦¬:</strong> ${teamWin["ì„ "]}`));
  summary.appendChild(createP(`ğŸ˜ˆ <strong>ì•…íŒ€ ìŠ¹ë¦¬:</strong> ${teamWin["ì•…"]}`));
  summary.appendChild(hr());

  // ìºë¦­í„°ë³„ ìŠ¹ë¥ 
  const title = document.createElement("h3");
  title.className = "text-3xl font-bold";
  title.textContent = "ìºë¦­í„°ë³„ ìŠ¹ë¥ ";
  summary.appendChild(title);

  const list = document.createElement("ul");
  list.className = "text-left inline-block";

  let rank = 0;
  sortEntries(charWins).forEach(([c,d])=>{
    // 1ìŠ¹ 100% ìºë¦­í„°ëŠ” ì œì™¸
    if (rank >= 10) return;
    if(d.total === 1 && d.win === 1) return;

    rank++;
    const pct = ((d.win/d.total)*100).toFixed(1);
    const li = document.createElement("li");
    li.innerHTML = `<strong>${rank}ìœ„.</strong> ${getIcon(c)} <strong>${c}</strong>: ${d.win}ìŠ¹ / ${d.total}ì „ (${pct}%)`;
    list.appendChild(li);
  });
  summary.appendChild(list);
}

// ì´ë²¤íŠ¸ ë°”ì¸ë”©
document.getElementById("scenarioFilter").addEventListener("change", build);
document.getElementById("monthFilter").addEventListener("change", build);

// ì´ˆê¸° ë¡œë“œ
window.onload = async () =>{
  await populateMonths();
  build();
};
</script>
</body>
</html>
