<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê²Œì„ ê²°ê³¼ ë“±ë¡</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="max-w-2xl mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-6">ğŸ® ê²Œì„ ê²°ê³¼ ë“±ë¡</h1>

    <form id="gameForm" class="space-y-4 bg-white shadow p-6 rounded">
      <!-- ë‚ ì§œ -->
      <div>
        <label class="block mb-1 font-semibold">ë‚ ì§œ</label>
        <input type="date" name="date" class="w-full border rounded p-2" required />
      </div>

      <!-- ì‹œë‚˜ë¦¬ì˜¤ -->
      <div>
        <label class="block mb-1 font-semibold">ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</label>
        <select name="scenario" id="scenario" class="w-full border rounded p-2" required>
          <option value="">â–¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
          <option>íŠ¸ëŸ¬ë¸” ë¸Œë£¨ì‰</option>
          <option>ì„¹ì¸ ì•¤ë°”ì´ì˜¬ë ›</option>
          <option>ë°°ë“œë¬¸ë¼ì´ì§•</option>
          <option>í¬ì¼“ëª¬ìŠ¤í„°</option>
          <option>ë°˜ë€ì˜ ê±°ì¹œë°”ë‹¤</option>
          <option>ë¡œë§ˆ</option>
        </select>
      </div>

      <!-- ì „ì²´ ìŠ¹ë¦¬ íŒ€ -->
      <div>
        <label class="block mb-1 font-semibold">ìŠ¹ë¦¬ íŒ€</label>
        <select name="winningTeam" id="winningTeam" class="w-full border rounded p-2" required>
          <option value="">â–¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
          <option value="ì„ íŒ€">ì„ íŒ€ ìŠ¹ë¦¬</option>
          <option value="ì•…íŒ€">ì•…íŒ€ ìŠ¹ë¦¬</option>
        </select>
      </div>

      <!-- í”Œë ˆì´ì–´ ìˆ˜ -->
      <div>
        <label class="block mb-1 font-semibold">í”Œë ˆì´ì–´ ìˆ˜</label>
        <input
          type="number"
          id="playerCount"
          name="playerCount"
          min="1"
          max="20"
          value="5"
          class="w-full border rounded p-2"
          required
        />
      </div>

      <!-- í”Œë ˆì´ì–´ ì…ë ¥ ì˜ì—­ -->
      <div id="playerInputs" class="space-y-4"></div>

      <button
        type="submit"
        class="w-full bg-blue-500 text-white font-semibold py-2 rounded hover:bg-blue-600"
      >
        ì €ì¥í•˜ê¸°
      </button>
    </form>

    <div class="mt-4 text-center">
      <a href="index.html" class="text-blue-500 hover:underline">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>

  <script>
    /* Firebase ì„¤ì • */
    const firebaseConfig = {
      apiKey: "AIzaSyCqk52hH5uwWvC8L81l8d6kZgCN2Ynt_Rg",
      authDomain: "blood-on-the-clock-tower-613ce.firebaseapp.com",
      projectId: "blood-on-the-clock-tower-613ce",
      storageBucket: "blood-on-the-clock-tower-613ce.appspot.com",
      messagingSenderId: "619177302977",
      appId: "1:619177302977:web:3b282744ff5b00469e6d40",
      measurementId: "G-W8THYT2M1J",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    /* ê´€ë¦¬ì ì´ë©”ì¼ */
    const allowedEmail = "skyhk1202@naver.com";

    /* ìºë¦­í„° ë°ì´í„° (ìƒëµâ€¦ ì´ì „ ë‹µë³€ê³¼ ë™ì¼) */
    // characterData removed (now Firestore-driven)

    /* ê¶Œí•œ ì²´í¬ â†’ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ */
    auth.onAuthStateChanged((user) => {
      if (!user || user.email !== allowedEmail) {
        window.location.replace("login.html");
      }
    });

    /* í”Œë ˆì´ì–´ ì…ë ¥ ë™ì  ìƒì„± */
    function updatePlayerInputs(count) {
      const scenario = document.getElementById("scenario").value;
      const characters = characterData[scenario] || [];
      const container = document.getElementById("playerInputs");
      container.innerHTML = "";

      for (let i = 0; i < count; i++) {
        const div = document.createElement("div");
        div.innerHTML = `
          <div class="p-3 bg-gray-50 rounded shadow">
            <h3 class="font-semibold mb-2">í”Œë ˆì´ì–´ ${i + 1}</h3>
            <input type="text" name="player${i}_name" placeholder="ì´ë¦„" class="w-full border rounded p-2 mb-2" required>
            <select name="player${i}_character" class="w-full border rounded p-2 mb-2" required>
              <option value="">ìºë¦­í„° ì„ íƒ</option>
              ${characters.map(c => `<option value="${c}">${c}</option>`).join("")}
            </select>
            <select name="player${i}_win" class="w-full border rounded p-2" required>
              <option value="ìŠ¹ë¦¬">ìŠ¹ë¦¬</option>
              <option value="íŒ¨ë°°">íŒ¨ë°°</option>
            </select>
          </div>
        `;
        container.appendChild(div);
      }
    }

    /* ì´ë²¤íŠ¸ ë°”ì¸ë”© */
    document.getElementById("playerCount").addEventListener("change", () => {
      updatePlayerInputs(+document.getElementById("playerCount").value);
    });
    document.getElementById("scenario").addEventListener("change", () => {
      updatePlayerInputs(+document.getElementById("playerCount").value);
    });

    /* í¼ ì œì¶œ */
    document.getElementById("gameForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const date        = e.target.date.value;
      const scenario    = e.target.scenario.value;
      const winningTeam = e.target.winningTeam.value;
      const playerCount = +e.target.playerCount.value;

      const players = [];
      for (let i = 0; i < playerCount; i++) {
        players.push({
          name:      e.target[`player${i}_name`].value,
          character: e.target[`player${i}_character`].value,
          win:       e.target[`player${i}_win`].value,
        });
      }

      await db.collection("games").add({
        date,
        scenario,
        winningTeam,
        players,
        timestamp: new Date(),
      });

      alert("ë°ì´í„°ê°€ Firebaseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      e.target.reset();
      updatePlayerInputs(5);
    });

    /* ì´ˆê¸° 5ì¸ ì„¸íŒ… */
    updatePlayerInputs(5);
  </script>

<script>
  /* Firebase ì´ˆê¸°í™”ëŠ” í˜ì´ì§€ ìƒë‹¨ì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì • */

  /* ê´€ë¦¬ì ì¸ì¦ */
  const allowedEmail = "skyhk1202@naver.com";

  let charMaster = {}; // {ì´ë¦„: role}
  let sheets = {};     // {ì‹œíŠ¸ì´ë¦„: {name,isCustom,characters:[]}}
  const scenarioSel = document.getElementById("scenario");

  firebase.auth().onAuthStateChanged(async user=>{
    if(!user || user.email !== allowedEmail){
      window.location.replace("login.html");
      return;
    }
    await loadData();
  });

  /* ===== ë°ì´í„° ë¡œë“œ ===== */
  async function loadData(){
    /* 1. ìºë¦­í„° ë§ˆìŠ¤í„° */
    const charsSnap = await db.collection("characters").get();
    charsSnap.forEach(doc=>{
      const d = doc.data();
      charMaster[d.name] = d.role; // role: townsfolk|outsider|minion|demon
    });

    /* 2. ì‹œíŠ¸ ëª©ë¡ */
    const sheetSnap = await db.collection("sheets").get();
    sheetSnap.forEach(doc=>{
      const d = doc.data();
      sheets[d.name] = d;
    });

    /* 3. ì‹œë‚˜ë¦¬ì˜¤ ë“œë¡­ë‹¤ìš´ */
    const originals = Object.values(sheets).filter(s=>!s.isCustom);
    const customs   = Object.values(sheets).filter(s=> s.isCustom);
    const makeOpt = s => `<option value="\${s.name}">\${s.name}</option>`;
    scenarioSel.innerHTML =
      '<option value="">â–¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>' +
      (originals.length ? '<optgroup label="ì˜¤ë¦¬ì§€ë„">' + originals.map(makeOpt).join("") + '</optgroup>' : '') +
      (customs.length   ? '<optgroup label="ì»¤ìŠ¤í…€">'   + customs.map(makeOpt).join("")   + '</optgroup>' : '');

    updatePlayerInputs(+document.getElementById("playerCount").value);
  }

  /* ===== í”Œë ˆì´ì–´ ì…ë ¥ ì˜ì—­ ìƒì„± ===== */
  function updatePlayerInputs(count){
    const scenario = scenarioSel.value;
    const chars = (sheets[scenario]?.characters) || [];

    const container = document.getElementById("playerInputs");
    container.innerHTML = "";

    for(let i=0;i<count;i++){
      const charInput = chars.length ?
        '<select name="player'+i+'_character" id="player'+i+'_character" class="w-full border rounded p-2" required>' +
        '<option value="">â–¼ ìºë¦­í„° ì„ íƒ</option>' +
        chars.map(c=>'<option value="'+c+'">'+c+'</option>').join("") +
        '</select>' :
        '<input list="charList" name="player'+i+'_character" id="player'+i+'_character" class="w-full border rounded p-2" placeholder="ìºë¦­í„° ì´ë¦„ ì…ë ¥" required>';

      container.insertAdjacentHTML("beforeend",
        '<div class="p-3 bg-gray-50 rounded mb-4 space-y-2">' +
          '<h3 class="font-semibold mb-2">í”Œë ˆì´ì–´ '+(i+1)+'</h3>' +
          '<input type="text" name="player'+i+'_name" placeholder="ì´ë¦„" class="w-full border rounded p-2" required />' +
          charInput +
          '<select name="player'+i+'_win" class="w-full border rounded p-2" required>' +
            '<option value="">â–¼ ìŠ¹/íŒ¨ ì„ íƒ</option>' +
            '<option value="ìŠ¹ë¦¬">ìŠ¹ë¦¬</option>' +
            '<option value="íŒ¨ë°°">íŒ¨ë°°</option>' +
          '</select>' +
        '</div>');
    }

    // datalist for autocomplete
    document.getElementById("charList")?.remove();
    const dl = document.createElement("datalist");
    dl.id = "charList";
    dl.innerHTML = Object.keys(charMaster).map(c=>'<option value="'+c+'">').join("");
    document.body.appendChild(dl);
  }

  /* ===== ì´ë²¤íŠ¸ ===== */
  document.getElementById("playerCount").addEventListener("input", e=>{
    updatePlayerInputs(+e.target.value);
  });
  scenarioSel.addEventListener("change", ()=>{
    updatePlayerInputs(+document.getElementById("playerCount").value);
  });
</script>

</body>
</html>
